<h1>Food Storage Inventory</h1>
<a href="/">‚Üê Back to Weekly Plan</a>

<form method="POST" action="/storage">
  <input id="barcode" placeholder="Scan or type barcode" />
  <button type="button" onclick="fetchFromBarcode()">üîç Lookup</button>
  <br />

  <input name="name" placeholder="Food name" required />
  <input name="quantity" placeholder="How many units?" type="number" required />
  <input name="unit" placeholder="e.g. bag, box" />
  <input name="servingsPerUnit" placeholder="Servings per unit" type="number" required />
  <input name="expires" type="date" />
  <select name="category" required>
    <option value="">-- Select Category --</option>
    <option value="Breakfast">Breakfast</option>
    <option value="Lunch">Lunch</option>
    <option value="Dinner">Dinner</option>
    <option value="Snack">Snack</option>
    <option value="Pantry">Pantry</option>
    <option value="Freezer">Freezer</option>
  </select>
  <button type="submit">Add</button>
</form>

<script>
  async function fetchFromBarcode() {
    const barcode = document.getElementById("barcode").value.trim();
    const result = document.getElementById("lookupResult");
    if (!barcode) return alert("Please enter a barcode");

    try {
      const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
      const data = await res.json();

      if (data.status !== 1) {
        result.textContent = "‚ùå Product not found.";
        return;
      }

      const product = data.product;
      const p = product.nutriments || {};

      // Auto-fill form fields
      document.getElementById("name").value = product.product_name || "Unnamed Product";
      document.querySelector("input[name='caloriesPerServing']")?.remove();
      const hiddenInput = document.createElement("input");
      hiddenInput.type = "hidden";
      hiddenInput.name = "caloriesPerServing";
      hiddenInput.value = p["energy-kcal_serving"] || 0;
      document.getElementById("storageForm").appendChild(hiddenInput);

      result.textContent = "‚úÖ Product info loaded. Complete remaining fields and click Add.";
    } catch (err) {
      console.error(err);
      result.textContent = "‚ùå Error fetching product.";
    }
  }
</script>


<h2>Current Inventory</h2>

<% if (Object.keys(grouped).length === 0) { %>
  <p>No items in storage yet.</p>
<% } else { %>
  <% for (let category in grouped) { %>
    <h3><%= category %></h3>
    <ul>
      <% grouped[category].forEach(item => { %>
        <li>
          <strong><%= item.name %></strong>:
          <%= item.quantity %> <%= item.unit %>
          (Expires: <%= new Date(item.expires).toDateString() %>)<br>
          <em>Category: <%= item.category %></em><br>

          <% if (item.stats) { %>
            üçΩ Total Calories: <%= item.stats.totalCalories.toLocaleString() %> kcal  
            | Protein: <%= item.stats.totalProtein %>g  
            | Covers: <%= item.stats.daysOfSupport %> day(s) for 5 people
          <% } else { %>
            <em>Nutrition data incomplete.</em>
          <% } %>

          <form method="POST" action="/storage/delete/<%= item._id %>" style="display:inline;">
            <button onclick="return confirm('Delete this item?')">üóëÔ∏è</button>
          </form>
          <a href="/storage/edit/<%= item._id %>">‚úèÔ∏è Edit</a>
        </li>
      <% }) %>
    </ul>
  <% } %>
<% } %>